# 스트림 병렬화는 주의해서 적용하라
주류 언어 중 동시성 측면에서 자바는 항상 앞서갔다.
- 처음 릴리스된 1996년부터 스레드, 동기화, wait/notify를 지원
- 자바 5부터 동시성 컬렉션인 `java.util.concurrent` 라이브러리와 실행자 프레임워크 지원
- 자바 7주터 고성능 병렬분해 프레임워크인 포크-조인(fork-join) 패키지를 추가
- 자바 8부터는 parallel 메서드만 호출하면 병렬 실행할 수 있는 스트림 지원

> 자바로 동시성 프로그램을 작성하기가 점점 쉬워지고 있지만 올바르고 빠르게 작성하기는 여전히 어려운 작업이다.  
> 동시성 프로그래밍을 할 때는 안전성(safety)과 응답 가능(liveness) 상태를 유지하기 위해 애써야하는데, 병렬 스트림 파이프라인 프로그래밍에서도 같다.

#
### 스트림 병렬화가 성능을 악화 시키는 경우

```java
public static void main(String[] args) {
   primes().map(p -> TWO.pos(p.intValueExact()).subtract(ONE))
      .fileter(mersenne -> mersenne.isProbablePrime(50))
      .limit(20)
      .forEach(System.out::println);
}

static Stream<BigInteger> primes() {
   return Stream.iterate(TWO, BigInteger::nextProbablePrime);
}
```
- 위 프로그램의 속도를 높이고 싶어 스트림 파이프라인의 `parallel()`을 호출해도 속도는 빨라지지 않음
- 스트림 라이브러리가 이 파이프라인을 병렬화하는 방법을 찾기 못해 아무것도 출력하지 못하면서 CPU의 90%를 잡아먹는 상태가 됨

#### 데이터 소스가 Stream.iterate거나 중간 연산으로 limit를 쓰면 파이프라인 병렬화로 성능 개선을 기대할 수 없다!
> 스트림 파이프라인을 마구잡이로 병렬화 하면 성능이 오히려 끔찍하게 나빠질 수도 있다.

#
### 스트림 병렬화 사용 시 효과가 좋은 자료구조

> #### 스트림의 소스가 `ArrayList`, `HashMap`, `HashSet`, `ConcurrentHashMap`의 인스턴스거나 `배열`, `int 범위`, `long 범위`일 때 병렬화의 효과가 가장 좋다!!

#### 💡 효과 좋은 자료구조들의 공통점
__(1) 데이터를 원하는 크기로 정확하고 손쉽게 나눌 수 있다__ 
- 일을 다수의 스레드에 분배하기에 좋은 특징을 가진 자료구조들이 병렬화 사용 시 효과가 좋음
- 나누는 작업은 Spliterator가 담당하며 Spliterator 객체는 Stream이나 Iterable의 spliterator 메서드로 얻어올 수 있음

__(2) 참조 지역성이 뛰어나다__
- 원소들을 순차적으로 실행할 때 참조 지역성이 뛰어나 이웃한 원소의 참조들이 메모리에 연속해서 저장되어 있음
- 참조 직역성이 낮으면 스레드는 데이터가 주 메모리에서 캐시 메모리로 전송되어 오기를 기다리며 시간을 허비
- 다량의 데이터를 처리하는 벌크 연산을 병렬화 할 때 참조 지역성은 매우 중요한 요소
- 참조 지역성이 가장 뛰어난 자료구조는 데이터 자체가 메모리에 연속되어 저장되는 기본 타입의 배열

#
### 스트림 파이프라인의 종단 연산과 병렬 수행의 효율성
> 스트림 파이프라인의 종단연산의 동작 방식은 병렬 수행 효율에 영향을 준다
- 종단 연산에서 수행하는 작업이 파이프라인의 전체 작업량 중 상당 비중을 차지하기 때문에 순차적인 연산이라면 병렬 수행의 효과는 제한될 수 밖에 없음
- 종단 연산 중 병렬화에 가장 적합한 것은 축소(reduction: 파이프라인의 원소를 하나로 합치는 작업 - reduce 메서드 , min, mac, count, sum)
- `anyMatch`, `allMatch`, `noneMatch` 처럼 조건에 맞으면 바로 반환되는 메서드도 병렬화에 적합
- 가변 축소를 수행하는 `collect`는 병렬화에 부적합

#
### 스트림 병렬화의 성능 고려사항
> #### 스트림을 잘못 병렬화 하면 성능이 나빠질 뿐만 아니라 결과 자체가 잘못되거나 예상 못한 동작이 발생할 수 있다!
- 직접 구현한 Stream, Iterable, Collection를 제대로 병렬화 하고 싶다면 `spliterator`메서드를 반드시 재정의하고 성능을 강도 높게 테스트하자
- 스트림 병렬화는 오직 성능 최적화 수단일 뿐이다 (성능 테스트를 통해 병렬화의 가치가 있는지 판단 필요)

> 실제로 스트림 파이프라인을 병렬화해 성능을 개선하는 경우가 많이 없을 것이다.  
> 하지만 조건이 잘 갖춰질 경우 `parallel` 메서드 호출 하나로 프로세서 코어 수에 비례하는 성능 향상을 가져올 수 도 있으므로 잘 생각해서 사용하자.
 
 
